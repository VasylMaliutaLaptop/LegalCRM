@page "/register"
@attribute [AllowAnonymous]
@using System.Net.Http.Json
@using LegalCRM.Shared.Contracts
@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Components.Forms
@inject HttpClient Http
@inject NavigationManager Nav

<h3>Регистрация пользователя</h3>

<EditForm Model="@_registerDTO" OnValidSubmit="HandleRegister">
    <DataAnnotationsValidator />
    <ValidationSummary />

    <div>
        <label>Имя пользователя:</label>
        <InputText @bind-Value="_registerDTO.UserName" />
    </div>
    <div>
        <label>Email:</label>
        <InputText @bind-Value="_registerDTO.Email" type="email" />
    </div>
    <div>
        <label>Пароль:</label>
        <InputText @bind-Value="_registerDTO.Password" type="password" />
    </div>

    <button type="submit" disabled="@busy">Зарегистрироваться</button>
</EditForm>

@if (!string.IsNullOrEmpty(message))
{
    <p>@message</p>
}

@code {
    private RegisterDTO _registerDTO = new();
    private string? message;
    private bool busy;

    private async Task HandleRegister()
    {
        try
        {
            busy = true;
            message = null;

            // предполагается, что Http.BaseAddress уже указывает на API
            var resp = await Http.PostAsJsonAsync("api/account/register", _registerDTO);
            if (resp.IsSuccessStatusCode)
            {
                // при успехе — перейти на логин или на returnUrl при наличии
                var uri = Nav.ToAbsoluteUri(Nav.Uri);
                var q = Microsoft.AspNetCore.WebUtilities.QueryHelpers.ParseQuery(uri.Query);
                var returnUrl = q.TryGetValue("returnUrl", out var v) ? v.ToString() : "/login";
                Nav.NavigateTo(returnUrl);
            }
            else
            {
                var error = await resp.Content.ReadAsStringAsync();
                message = string.IsNullOrWhiteSpace(error) ? "Ошибка регистрации" : $"Ошибка регистрации: {error}";
            }
        }
        finally { busy = false; }
    }
}
